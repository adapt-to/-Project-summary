==================
随机赋值电压的输出
==================

预期目标：
 1. 连续输出设定的多个电压值
 2. 输出频率满足预设
 3. 电压值为随机输出
 4. 由FPGA完成上述工作

------------------------------------------------------------

目标选型
=================

 ————要完成预期目标必须要有基础支撑，设备型号的正确选择是高效完成目标的前提和基础

完成本目标我的选型如下：
 1. FPGA选型 —— 黑金FPGA开发板-AX530 (CycloneIV EP4CE30)
 
 .. note::
  .. image:: ./fpga.jpg
    :width: 400px
  此型号FPGA的板内资源如图所示，足以胜任本目标的完成。

  官网报价：RMB-1299 链接：`AX530 <https://detail.tmall.com/item.htm?spm=a230r.1.14.6.632f5a7fhbWb7E&id=548163665175&cm_id=140105335569ed55e27b&abbucket=7>`_ 

 2. DAC模块选型 —— 黑金14位双通道DA模块-AN9767

 .. note::
  .. image:: ./dac.jpg

  此DAC模块是目前在黑金官网能够购买到的采样率最高的DA模块，DA更新速率高达 **125M-SPS**

 .. warning::
  怎样理解AD/DA模块的更新速率(或采样速率)：
   为了保证转换的正确完成，采样速率（Sample Rate）必须小于或等于转换速率。可以说转换速率是最大采样速率，\
   因此有人习惯上将转换速率在数值上等同于采样速率也是可以接受的。常用单位是KSPS或MSPS（1MSPS=1000KSPS）

   例如上述的125MSPS便是指：每秒钟的数模的采样数为125M个。
  怎样理解MSPS或KSPS和频率的关系：
   输出的频率需要联系到我们的需求，\
   我们将数据波形数据先写入ROM中，然后利用DA模块输出模拟信号

   以本型号的DA模块为例，假设ROM中存储的数据宽度为14bit，存储数据深度为1024。
   如果我们以1个周期采8个点来计算，那么1024的数据深度一共可以采 1024/8=128个周期的数据。然后再利用采样率125MSPS比上128即得到此时的输出频率为125M/128=15.6MHz
   1个周期内的采样点越多，因为ROM的数据深度固定，那么输出的频率就会越小。

------------------------------------------------------------

可行性分析
=================

 ——虽然上述的选型中描述了FPGA板的型号以及DA模块的型号，但是如何能够保证目标顺利完成还需要有 **算法** 的帮助

我在此采用的思想是：
 1. 利用FPGA内嵌的 **ROM** 预存多值电压的数据，因为 **ROM** 的特点是掉电数据不丢失，所以只要预先将我们需要的电压值写入ROM即可
 2. 利用多选一数据选择器，随机的选择ROM中的哪一些地址段的数据
 3. 通过DA将选择的地址端的数据输出

.. note::
 **思想来源**
  
  使用这个方法是我在查看AN9767的用户手册中想到的，在手册中给出了如何将存储在ROM中的正弦波数据通过DA模块输出到示波器上。
  所以我这个思想是在它的基础上构建而成，具有可行性！
  
  :download:`下载AN9767用户手册 <AN9767REV1.0.pdf>`

------------------------------------------------------------

具体实施
=================

.. image:: ./shiyitu.png

如图所示，这是此设计的大致模型图：
 1. 由PLL锁相环生成高频的时钟
 2. 由SEL数据选择器选择不同的地址位
 3. 由PLL和SEL共同作用，使ROM中的数据输出
 4. ROM的数字信号通过AN9767转换成模拟信号
 5. 通过BNC线连接示波器显示

下面分别介绍一下，各个模块的具体实现

预设电压值
--------------------

预设电压值，需要用到工具——**波形数据生成器**

操作步骤如下：
 1. 双击exe文件打开该工具
 2. 点击 **查看 --> 全局参数**，设置为如下：
  .. image:: ./canshu.PNG
   :width: 200
 3. 设置后能立即看到网格图发生了变化
 4. 点击 **查看 --> 数据曲线**，设置后便能看到波形曲线
 5. 点击 **手绘波形 --> 线条**，此时切换到手绘模式
 6. 手动在图中绘制想要设置的波形
 7. 点击 **保存** 选择合适位置保存即可（默认保存为.mif文件）

下图是我设置的电压值的缩略图：

.. image:: ./image_v.png
 :width: 200px

由图可以看到，我手绘了4个不同高度的电压值。
通过记事本打开保存的.mif文件，可以看到图形其实是由这些十六进制数据保存在文件中的

 .. image:: ./image_v_dig.png
  :width: 200px

参考下载：
 :download:`波形生成器 <Guagle_wave.exe>`

 :download:`参考.mif文件 <four_v.mif>`

数据选择器
--------------------

.. image:: ./sel.jpg
选择器的原理很简单，利用A\ :sub:`1`\ A\ :sub:`0`\ 的数据选择特性选择不同的输出

=========================================== ===========
选择输入：A\ :sub:`1`\ A\ :sub:`0`\          输出 F
------------------------------------------- -----------
00                                          D\ :sub:`0`\
------------------------------------------- -----------
01                                          D\ :sub:`1`\
------------------------------------------- -----------
10                                          D\ :sub:`2`\
------------------------------------------- -----------
11                                          D\ :sub:`3`\
=========================================== ===========

具体实现的verilog代码如下 ::

    module mux( d1, d2, d3, d4, sel, dout);
        
        input d1;
        input d2;
        input d3;
        input d4;
        input [1:0] se1;
        
        output out;
        reg out;
        
        always @(d1 or d2 or d3 or d4 or sel)
        
        case({sel})
            2'b00 : out = d1;
            2'b01 : out = d2;
            2'b10 : out = d3;
            2'b11 : out = d4;
        endcase

    endmodule

ROM的设置
--------------------

采用IP核能够快速设置ROM， 方法如下：

 1. 在 *Quartus II* 中，点击 **Tool --> MegaWizard Plug-In Manager** 在弹出的窗口选择第一项 *Create a new custom megafunction variation*
 2. 在左侧中选择 **ROM:1-PORT**, 再在 *output file* 栏里输入IP的名称以及存放IP的目录，语法选择Verliog
 3. 设置 ROM 的数据宽度为14bits,数据的深度为1024个数据，如下图红框所示
  .. image:: ./rom1.png
   :width: 300px
 4. 中间的步骤默认点击 *next* 即可，直到到达下图页面，设置之前保存好的mif文件
   .. image:: ./rom2.PNG
    :width: 300px
 5. 继续点击 *next* 直到最后，点击 **Finish**，这样一个ROM的IP核就设置完成
 
设置完成后，能在 *Quartus II* 中查看到设置好的IP核，如果想改动参数，直接双击即可再次进入设置流程重新设置

协同配合
--------------------




